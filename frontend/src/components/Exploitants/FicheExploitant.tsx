import {
  Badge,
  Box,
  Button,
  Card,
  Flex,
  Grid,
  GridItem,
  Heading,
  Table,
  Tabs,
  Text,
} from "@chakra-ui/react"
import { useQuery } from "@tanstack/react-query"
import { FiEdit2, FiMail, FiMapPin, FiPhone, FiUser } from "react-icons/fi"

import { CadastreService, ParcellesService, type ExploitantPublic } from "@/client"
import {
  DialogBody,
  DialogCloseTrigger,
  DialogContent,
  DialogHeader,
  DialogRoot,
  DialogTitle,
} from "@/components/ui/dialog"

interface FicheExploitantProps {
  exploitant: ExploitantPublic
  isOpen: boolean
  onClose: () => void
  onEdit?: () => void
}

function formatCurrency(value: string | number | null | undefined): string {
  if (!value) return "-"
  const num = Number(value)
  return new Intl.NumberFormat("fr-FR", {
    style: "currency",
    currency: "EUR",
  }).format(num)
}

function formatSurface(surface: string | number | null | undefined): string {
  if (!surface) return "-"
  const num = Number(surface)
  return `${num.toFixed(4)} ha`
}

// Onglet Fiche Exploitant
function FicheTab({ exploitant }: { exploitant: ExploitantPublic }) {
  return (
    <Box>
      <Grid templateColumns={{ base: "1fr", md: "1fr 1fr" }} gap={6}>
        {/* Informations personnelles */}
        <Card.Root>
          <Card.Header>
            <Flex align="center" gap={2}>
              <FiUser />
              <Heading size="sm">Informations personnelles</Heading>
            </Flex>
          </Card.Header>
          <Card.Body>
            <Grid templateColumns="120px 1fr" gap={2}>
              <Text fontWeight="medium" color="gray.500">
                Nom
              </Text>
              <Text>{exploitant.nom}</Text>

              <Text fontWeight="medium" color="gray.500">
                Prénom
              </Text>
              <Text>{exploitant.prenom || "-"}</Text>
            </Grid>
          </Card.Body>
        </Card.Root>

        {/* Coordonnées */}
        <Card.Root>
          <Card.Header>
            <Flex align="center" gap={2}>
              <FiMapPin />
              <Heading size="sm">Coordonnées</Heading>
            </Flex>
          </Card.Header>
          <Card.Body>
            <Grid templateColumns="120px 1fr" gap={2}>
              <Text fontWeight="medium" color="gray.500">
                Adresse
              </Text>
              <Text>{exploitant.adresse || "-"}</Text>

              <Text fontWeight="medium" color="gray.500">
                Code postal
              </Text>
              <Text>{exploitant.code_postal || "-"}</Text>

              <Text fontWeight="medium" color="gray.500">
                Ville
              </Text>
              <Text>{exploitant.ville || "-"}</Text>
            </Grid>
          </Card.Body>
        </Card.Root>

        {/* Contact */}
        <Card.Root>
          <Card.Header>
            <Flex align="center" gap={2}>
              <FiPhone />
              <Heading size="sm">Contact</Heading>
            </Flex>
          </Card.Header>
          <Card.Body>
            <Grid templateColumns="120px 1fr" gap={2}>
              <Text fontWeight="medium" color="gray.500">
                Téléphone
              </Text>
              <Text>{exploitant.tel || "-"}</Text>

              <Text fontWeight="medium" color="gray.500">
                Email
              </Text>
              <Text>{exploitant.mail || "-"}</Text>
            </Grid>
          </Card.Body>
        </Card.Root>
      </Grid>
    </Box>
  )
}

// Onglet Cadastre
function CadastreTab({ exploitant }: { exploitant: ExploitantPublic }) {
  const { data, isLoading } = useQuery({
    queryKey: ["parcelles-exploitant", exploitant.id],
    queryFn: () =>
      ParcellesService.readParcellesByExploitant({
        exploitantId: exploitant.id,
        skip: 0,
        limit: 100,
      }),
  })

  const parcelles = data?.data || []

  // Calculer les totaux
  const totalSurface = parcelles.reduce((sum, p) => sum + Number(p.total_surface || 0), 0)
  const nbParcelles = parcelles.length

  if (isLoading) {
    return <Text>Chargement des parcelles...</Text>
  }

  return (
    <Box>
      {/* Totaux */}
      <Grid templateColumns="repeat(3, 1fr)" gap={4} mb={4}>
        <Card.Root size="sm">
          <Card.Body>
            <Text fontSize="xs" color="gray.500">
              Nombre de parcelles
            </Text>
            <Text fontSize="xl" fontWeight="bold">
              {nbParcelles}
            </Text>
          </Card.Body>
        </Card.Root>
        <Card.Root size="sm">
          <Card.Body>
            <Text fontSize="xs" color="gray.500">
              Surface totale
            </Text>
            <Text fontSize="xl" fontWeight="bold">
              {formatSurface(totalSurface)}
            </Text>
          </Card.Body>
        </Card.Root>
        <Card.Root size="sm">
          <Card.Body>
            <Text fontSize="xs" color="gray.500">
              Subdivisions
            </Text>
            <Text fontSize="xl" fontWeight="bold">
              {parcelles.reduce((sum, p) => sum + (p.nb_subdivisions || 0), 0)}
            </Text>
          </Card.Body>
        </Card.Root>
      </Grid>

      {/* Liste des parcelles */}
      <Table.Root size="sm">
        <Table.Header>
          <Table.Row>
            <Table.ColumnHeader>Référence</Table.ColumnHeader>
            <Table.ColumnHeader>Commune</Table.ColumnHeader>
            <Table.ColumnHeader>Lieu-dit</Table.ColumnHeader>
            <Table.ColumnHeader>Surface</Table.ColumnHeader>
            <Table.ColumnHeader>Subdivisions</Table.ColumnHeader>
            <Table.ColumnHeader>Structure</Table.ColumnHeader>
          </Table.Row>
        </Table.Header>
        <Table.Body>
          {parcelles.length === 0 ? (
            <Table.Row>
              <Table.Cell colSpan={6}>
                <Text textAlign="center" py={4}>
                  Aucune parcelle associée à cet exploitant.
                </Text>
              </Table.Cell>
            </Table.Row>
          ) : (
            parcelles.map((parcelle) => (
              <Table.Row key={parcelle.id}>
                <Table.Cell fontWeight="medium">{parcelle.parcelle}</Table.Cell>
                <Table.Cell>{parcelle.nom_commune || "-"}</Table.Cell>
                <Table.Cell>{parcelle.nom_lieu_dit || "-"}</Table.Cell>
                <Table.Cell>{formatSurface(parcelle.total_surface)}</Table.Cell>
                <Table.Cell>{parcelle.nb_subdivisions || 0}</Table.Cell>
                <Table.Cell>
                  {parcelle.sctl ? (
                    <Badge colorPalette="green">SCTL</Badge>
                  ) : (
                    <Badge colorPalette="blue">GFA</Badge>
                  )}
                </Table.Cell>
              </Table.Row>
            ))
          )}
        </Table.Body>
      </Table.Root>
    </Box>
  )
}

// Onglet Fermage
function FermageTab({ exploitant }: { exploitant: ExploitantPublic }) {
  const currentYear = new Date().getFullYear()

  const { data: parcellesData, isLoading } = useQuery({
    queryKey: ["parcelles-exploitant", exploitant.id],
    queryFn: () =>
      ParcellesService.readParcellesByExploitant({
        exploitantId: exploitant.id,
        skip: 0,
        limit: 100,
      }),
  })

  const { data: totaux } = useQuery({
    queryKey: ["fermages-totaux-exploitant", exploitant.id, currentYear],
    queryFn: () =>
      ParcellesService.getFermagesTotaux({
        idExploitant: exploitant.id,
        annee: currentYear,
      }),
  })

  const { data: valeurPoint } = useQuery({
    queryKey: ["valeur-point", currentYear],
    queryFn: () => CadastreService.readValeurPointByAnnee({ annee: currentYear }),
  })

  const parcelles = parcellesData?.data || []

  if (isLoading) {
    return <Text>Chargement des fermages...</Text>
  }

  return (
    <Box>
      {/* Résumé fermage */}
      <Card.Root mb={4} bg="green.50">
        <Card.Body>
          <Flex justify="space-between" align="center">
            <Box>
              <Text fontWeight="medium">Total fermages {currentYear}</Text>
              <Text fontSize="3xl" fontWeight="bold" color="green.600">
                {formatCurrency(totaux?.total_montant)}
              </Text>
            </Box>
            <Box textAlign="right">
              <Text fontSize="sm" color="gray.500">
                Surface: {formatSurface(totaux?.total_surface)}
              </Text>
              <Text fontSize="sm" color="gray.500">
                Revenu cadastral: {formatCurrency(totaux?.total_revenu)}
              </Text>
            </Box>
          </Flex>
        </Card.Body>
      </Card.Root>

      {/* Valeurs de points */}
      <Card.Root mb={4} size="sm">
        <Card.Body>
          <Text fontWeight="medium" mb={2}>
            Valeurs de points {currentYear}
          </Text>
          <Grid templateColumns="repeat(4, 1fr)" gap={4}>
            <Box>
              <Text fontSize="xs" color="gray.500">
                Point GFA
              </Text>
              <Text fontWeight="bold">{valeurPoint?.valeur_point_gfa || "-"} €</Text>
            </Box>
            <Box>
              <Text fontSize="xs" color="gray.500">
                Point SCTL
              </Text>
              <Text fontWeight="bold">{valeurPoint?.valeur_point_sctl || "-"} €</Text>
            </Box>
            <Box>
              <Text fontSize="xs" color="gray.500">
                Suppl. GFA
              </Text>
              <Text fontWeight="bold">{valeurPoint?.valeur_supp_gfa || "-"} %</Text>
            </Box>
            <Box>
              <Text fontSize="xs" color="gray.500">
                Suppl. SCTL
              </Text>
              <Text fontWeight="bold">{valeurPoint?.valeur_supp_sctl || "-"} %</Text>
            </Box>
          </Grid>
        </Card.Body>
      </Card.Root>

      {/* Liste détaillée */}
      <Table.Root size="sm">
        <Table.Header>
          <Table.Row>
            <Table.ColumnHeader>Parcelle</Table.ColumnHeader>
            <Table.ColumnHeader>Commune</Table.ColumnHeader>
            <Table.ColumnHeader>Surface</Table.ColumnHeader>
            <Table.ColumnHeader>Structure</Table.ColumnHeader>
          </Table.Row>
        </Table.Header>
        <Table.Body>
          {parcelles.length === 0 ? (
            <Table.Row>
              <Table.Cell colSpan={4}>
                <Text textAlign="center" py={4}>
                  Aucune parcelle associée.
                </Text>
              </Table.Cell>
            </Table.Row>
          ) : (
            parcelles.map((parcelle) => (
              <Table.Row key={parcelle.id}>
                <Table.Cell fontWeight="medium">{parcelle.parcelle}</Table.Cell>
                <Table.Cell>{parcelle.nom_commune || "-"}</Table.Cell>
                <Table.Cell>{formatSurface(parcelle.total_surface)}</Table.Cell>
                <Table.Cell>
                  {parcelle.sctl ? (
                    <Badge colorPalette="green">SCTL</Badge>
                  ) : (
                    <Badge colorPalette="blue">GFA</Badge>
                  )}
                </Table.Cell>
              </Table.Row>
            ))
          )}
        </Table.Body>
      </Table.Root>
    </Box>
  )
}

export default function FicheExploitant({
  exploitant,
  isOpen,
  onClose,
  onEdit,
}: FicheExploitantProps) {
  return (
    <DialogRoot
      size="xl"
      placement="center"
      open={isOpen}
      onOpenChange={({ open }) => !open && onClose()}
    >
      <DialogContent maxW="900px">
        <DialogHeader>
          <Flex justify="space-between" align="center" w="full" pr={8}>
            <DialogTitle>
              {exploitant.nom} {exploitant.prenom}
            </DialogTitle>
            {onEdit && (
              <Button variant="ghost" size="sm" onClick={onEdit}>
                <FiEdit2 />
                Modifier
              </Button>
            )}
          </Flex>
        </DialogHeader>
        <DialogBody pb={6}>
          <Tabs.Root defaultValue="fiche">
            <Tabs.List>
              <Tabs.Trigger value="fiche">Fiche exploitant</Tabs.Trigger>
              <Tabs.Trigger value="cadastre">Cadastre</Tabs.Trigger>
              <Tabs.Trigger value="fermage">Fermage</Tabs.Trigger>
            </Tabs.List>

            <Tabs.Content value="fiche">
              <FicheTab exploitant={exploitant} />
            </Tabs.Content>
            <Tabs.Content value="cadastre">
              <CadastreTab exploitant={exploitant} />
            </Tabs.Content>
            <Tabs.Content value="fermage">
              <FermageTab exploitant={exploitant} />
            </Tabs.Content>
          </Tabs.Root>
        </DialogBody>
        <DialogCloseTrigger />
      </DialogContent>
    </DialogRoot>
  )
}
